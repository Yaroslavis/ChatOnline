<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üî• –£–º–Ω—ã–π –ß–∞—Ç —Å WebSocket</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      padding: 20px;
    }

    #auth, #chat {
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      padding: 25px;
      width: 400px;
      max-width: 95%;
      display: none;
      flex-direction: column;
      gap: 15px;
    }

    #auth.active, #chat.active {
      display: flex;
    }

    h3 {
      text-align: center;
      margin-top: 0;
      color: #333;
      font-size: 24px;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    input {
      padding: 12px;
      font-size: 14px;
      width: 100%;
      border: 2px solid #e1e1e1;
      border-radius: 8px;
      transition: border 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 8px;
      transition: all 0.3s;
      font-weight: 600;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-logout {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      padding: 8px 15px;
      font-size: 12px;
    }

    .btn-logout:hover {
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      background: #f8f9fa;
      padding: 15px;
      height: 300px;
      border-radius: 10px;
      border: 2px solid #e9ecef;
    }

    .message {
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      word-wrap: break-word;
      max-width: 80%;
      animation: messageAppear 0.3s ease-out;
    }

    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-incoming {
      background: white;
      border: 1px solid #e9ecef;
      margin-right: auto;
    }

    .message-outgoing {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      margin-left: auto;
      text-align: right;
    }

    .message-sender {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 4px;
      opacity: 0.8;
    }

    .message-time {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 4px;
    }

    #status {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-online {
      color: #28a745;
    }

    .status-offline {
      color: #dc3545;
    }

    .status-connecting {
      color: #ffc107;
    }

    .typing-indicator {
      font-style: italic;
      color: #666;
      font-size: 12px;
      height: 18px;
    }

    form {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }

    #input {
      flex: 1;
    }

    .auth-buttons {
      display: flex;
      gap: 10px;
    }

    .auth-buttons button {
      flex: 1;
    }

    #authStatus {
      min-height: 20px;
      text-align: center;
      font-size: 14px;
      margin-top: 5px;
    }

    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info { color: #17a2b8; }

    .online-users {
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      color: #666;
      border: 1px solid #e9ecef;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body>

  <!-- üîê –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div id="auth" class="active">
    <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üëã</h3>
    <input id="email" type="email" placeholder="üìß –í–∞—à email" />
    <input id="password" type="password" placeholder="üîí –ü–∞—Ä–æ–ª—å" />
    <input id="username" type="text" placeholder="üë§ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
    <div class="auth-buttons">
      <button id="registerBtn">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button id="loginBtn">üöÄ –í–æ–π—Ç–∏</button>
    </div>
    <div id="authStatus"></div>
  </div>

  <!-- üí¨ –ë–ª–æ–∫ —á–∞—Ç–∞ -->
  <div id="chat">
    <div class="chat-header">
      <div class="user-info">
        <div class="avatar" id="userAvatar">U</div>
        <div>
          <strong id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</strong>
          <div id="status" class="status-connecting">‚è≥ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...</div>
        </div>
      </div>
      <button class="btn-logout" id="logoutBtn">üö™ –í—ã–π—Ç–∏</button>
    </div>

    <div class="online-users" id="onlineUsers">
      üë• –û–Ω–ª–∞–π–Ω: 1
    </div>

    <div class="typing-indicator" id="typingIndicator"></div>

    <div id="messages"></div>

    <form id="form">
      <input id="input" autocomplete="off" placeholder="üí≠ –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button type="submit">üì§</button>
    </form>
  </div>

  <script>
    const API_URL = 'http://localhost:3000';
    const CHAT_ID = 1;

    const authBox = document.getElementById('auth');
    const chatBox = document.getElementById('chat');
    const emailEl = document.getElementById('email');
    const passwordEl = document.getElementById('password');
    const usernameEl = document.getElementById('username');
    const registerBtn = document.getElementById('registerBtn');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authStatus = document.getElementById('authStatus');
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const formEl = document.getElementById('form');
    const inputEl = document.getElementById('input');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const onlineUsers = document.getElementById('onlineUsers');
    const typingIndicator = document.getElementById('typingIndicator');

    let token = null;
    let userId = null;
    let username = null;
    let socket = null;
    let typingTimer = null;
    let onlineCount = 1;

    // üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('DOMContentLoaded', () => {
      const savedToken = localStorage.getItem('token');
      if (savedToken) {
        token = savedToken;
        verifyTokenAndConnect();
      }
    });

    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
    async function verifyTokenAndConnect() {
      try {
        const meRes = await fetch(`${API_URL}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!meRes.ok) throw new Error('–¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω');

        const meData = await meRes.json();
        userId = meData.id || meData.userId;
        username = meData.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

        if (!userId) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

        updateUserInfo();
        authBox.classList.remove('active');
        chatBox.classList.add('active');
        connectSocket();
        loadMessages();
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', e);
        localStorage.removeItem('token');
        token = null;
        showAuthStatus('‚ùå –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
      }
    }

    // üë§ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    function updateUserInfo() {
      userName.textContent = username;
      userAvatar.textContent = username.charAt(0).toUpperCase();
      userAvatar.style.background = getRandomGradient();
    }

    // üé® –°–ª—É—á–∞–π–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
    function getRandomGradient() {
      const gradients = [
        'linear-gradient(135deg, #667eea, #764ba2)',
        'linear-gradient(135deg, #f093fb, #f5576c)',
        'linear-gradient(135deg, #4facfe, #00f2fe)',
        'linear-gradient(135deg, #43e97b, #38f9d7)',
        'linear-gradient(135deg, #fa709a, #fee140)'
      ];
      return gradients[Math.floor(Math.random() * gradients.length)];
    }

    // üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    registerBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passwordEl.value.trim();
      const username = usernameEl.value.trim();

      if (!validateAuthInput(email, password, username)) return;

      try {
        const res = await fetch(`${API_URL}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, username }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message);
        }

        showAuthStatus('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.', 'success');
        passwordEl.value = '';
      } catch (e) {
        showAuthStatus(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      }
    });

    // üîê –õ–æ–≥–∏–Ω
    loginBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passwordEl.value.trim();

      if (!validateAuthInput(email, password)) return;

      try {
        const res = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message);
        }

        const data = await res.json();
        token = data.access_token;
        localStorage.setItem('token', token);

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const meRes = await fetch(`${API_URL}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!meRes.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

        const meData = await meRes.json();
        userId = meData.id || meData.userId;
        username = meData.username;

        if (!userId) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');

        updateUserInfo();
        authBox.classList.remove('active');
        chatBox.classList.add('active');
        connectSocket();
        loadMessages();
        
        showAuthStatus('', '');
      } catch (e) {
        showAuthStatus(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${e.message}`, 'error');
      }
    });

    // üö™ –í—ã—Ö–æ–¥
    logoutBtn.addEventListener('click', () => {
      logout();
    });

    function logout() {
      if (socket) {
        socket.disconnect();
      }
      localStorage.removeItem('token');
      token = null;
      userId = null;
      username = null;
      
      chatBox.classList.remove('active');
      authBox.classList.add('active');
      showAuthStatus('‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
      emailEl.value = '';
      passwordEl.value = '';
      usernameEl.value = '';
    }

    // ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
    function validateAuthInput(email, password, username = '') {
      if (!email || !password) {
        showAuthStatus('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å', 'error');
        return false;
      }
      if (username && username.length < 2) {
        showAuthStatus('‚ùå –ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        return false;
      }
      return true;
    }

    // üí¨ –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function showAuthStatus(message, type) {
      authStatus.textContent = message;
      authStatus.className = type;
    }

    // üåê –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–æ–∫–µ—Ç—É
    function connectSocket() {
      if (!token) {
        showStatus('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
        return;
      }

      socket = io(API_URL, {
        transports: ['websocket'],
        auth: { token }
      });

      socket.on('connect', () => {
        showStatus(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ`, 'success');
      });

      socket.on('disconnect', () => {
        showStatus('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ', 'error');
      });

      socket.on('connect_error', (error) => {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket:', error);
        showStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É', 'error');
      });

      // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      socket.on('message:receive', (data) => {
        addMessage(data.text, data.userId === userId, data.username || '–ê–Ω–æ–Ω–∏–º');
      });

      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç
      socket.on('user:typing', (data) => {
        if (data.userId !== userId) {
          showTyping(data.username);
        }
      });

      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Å—Ç–∞–ª –ø–µ—á–∞—Ç–∞—Ç—å
      socket.on('user:stop-typing', () => {
        hideTyping();
      });

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      socket.on('users:online', (data) => {
        onlineCount = data.count || 1;
        updateOnlineUsers();
      });
    }

    // ‚úçÔ∏è –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç"
    function handleTyping() {
      if (!socket) return;

      socket.emit('user:typing', {
        chatId: CHAT_ID,
        userId,
        username
      });

      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => {
        socket.emit('user:stop-typing', { chatId: CHAT_ID });
      }, 1000);
    }

    // üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
    function showTyping(username) {
      typingIndicator.textContent = `‚úçÔ∏è ${username} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
    }

    // üôà –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
    function hideTyping() {
      typingIndicator.textContent = '';
    }

    // üë• –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω
    function updateOnlineUsers() {
      onlineUsers.textContent = `üë• –û–Ω–ª–∞–π–Ω: ${onlineCount}`;
    }

    // üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = type === 'success' ? 'status-online' : 
                          type === 'error' ? 'status-offline' : 'status-connecting';
    }

    // üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    async function loadMessages() {
      try {
        const res = await fetch(`${API_URL}/chat/${CHAT_ID}/messages`);
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
        
        const data = await res.json();
        messagesEl.innerHTML = '';
        data.forEach(msg => {
          addMessage(
            msg.text, 
            msg.userId === userId, 
            msg.user?.username || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${msg.userId}`
          );
        });
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', e);
      }
    }

    // ‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    formEl.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      
      if (text === '') return;
      
      if (!userId) {
        alert('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ –≤ —á–∞—Ç.');
        return;
      }

      if (!socket || !socket.connected) {
        alert('‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è.');
        return;
      }

      socket.emit('message:send', {
        chatId: CHAT_ID,
        userId: userId,
        text: text
      });

      inputEl.value = '';
      hideTyping();
    });

    // ‚å®Ô∏è –°–æ–±—ã—Ç–∏–µ –ø–µ—á–∞—Ç–∏
    inputEl.addEventListener('input', handleTyping);

    // üí¨ –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
    function addMessage(text, isMine = false, sender = '–í—ã') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isMine ? 'message-outgoing' : 'message-incoming'}`;
      
      const senderDiv = document.createElement('div');
      senderDiv.className = 'message-sender';
      senderDiv.textContent = isMine ? '–í—ã' : sender;
      
      const textDiv = document.createElement('div');
      textDiv.className = 'message-text';
      textDiv.textContent = text;
      
      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = new Date().toLocaleTimeString('ru-RU', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      messageDiv.appendChild(senderDiv);
      messageDiv.appendChild(textDiv);
      messageDiv.appendChild(timeDiv);
      
      messagesEl.appendChild(messageDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // ‚å®Ô∏è –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    document.addEventListener('keydown', (e) => {
      // Ctrl+Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      if (e.ctrlKey && e.key === 'Enter') {
        formEl.dispatchEvent(new Event('submit'));
      }
      // Ctrl+L –¥–ª—è –≤—ã—Ö–æ–¥–∞
      if (e.ctrlKey && e.key === 'l') {
        logout();
      }
      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –ª—é–±–æ–º –Ω–∞–∂–∞—Ç–∏–∏ –≤ —á–∞—Ç–µ
      if (chatBox.classList.contains('active') && e.target !== inputEl) {
        inputEl.focus();
      }
    });
  </script>
</body>
</html>